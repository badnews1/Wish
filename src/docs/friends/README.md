# –°–∏—Å—Ç–µ–º–∞ –¥—Ä—É–∑–µ–π - –û–±–∑–æ—Ä

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏  
**–î–∞—Ç–∞:** 2025-01-15

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è

| –†–µ—à–µ–Ω–∏–µ | –í–∞—Ä–∏–∞–Ω—Ç |
|---------|---------|
| **–•—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä** | –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: –≤—Å–µ–≥–¥–∞ `LEAST(id1, id2), GREATEST(id1, id2)` |
| **–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ** | DELETE –∑–∞–ø–∏—Å—å (–Ω–µ —Å—Ç–∞—Ç—É—Å rejected) |
| **Race condition** | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–Ω—è—Ç–∏–µ –≤—Å—Ç—Ä–µ—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ |
| **–ü–∞–≥–∏–Ω–∞—Ü–∏—è** | Cursor-based, 20 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ |
| **Rate limiting** | 3 —É—Ä–æ–≤–Ω—è (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä—ã) |

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —ç—Ç–∞–ø–∞–º

### 1Ô∏è‚É£ [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](./1-database.sql)
- SQL –º–∏–≥—Ä–∞—Ü–∏—è (copy-paste ready)
- –¢–∞–±–ª–∏—Ü—ã: `friendships`, `friend_actions`
- –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è rate limiting –∏ —Å—á–µ—Ç—á–∏–∫–∞
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏

### 2Ô∏è‚É£ [API —Ö—É–∫–∏](./2-api-hooks.md)
- TypeScript —Ö—É–∫–∏ –¥–ª—è `entities/friend/api/`
- Mutations: send, accept, cancel, reject, delete
- Queries: —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π, –≤—Ö–æ–¥—è—â–∏–µ/–∏—Å—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã, –ø–æ–∏—Å–∫
- Cursor-based –ø–∞–≥–∏–Ω–∞—Ü–∏—è

### 3Ô∏è‚É£ [UI flows](./3-ui-flows.md)
- React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ UX –ª–æ–≥–∏–∫–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ race conditions
- –î–≤—É—Ö—Å–µ–∫—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ rate limiting

### 4Ô∏è‚É£ [–ß–µ–∫–ª–∏—Å—Ç](./4-checklist.md)
- –ü—Ä–æ–≥—Ä–µ—Å—Å –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏
- Backend, Frontend, –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üîÑ –î–∏–∞–≥—Ä–∞–º–º–∞ —Å—Ç–∞—Ç—É—Å–æ–≤

```
       none (–Ω–µ—Ç —Å–≤—è–∑–∏)
          ‚îÇ
          ‚ñº sendFriendRequest
       pending
          ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ           ‚îÇ
    ‚ñº           ‚ñº
 accept      cancel/reject
    ‚îÇ           ‚îÇ
    ‚ñº           ‚ñº
accepted      DELETE
    ‚îÇ
    ‚ñº delete
  DELETE
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è UI:**
- `none` - –Ω–µ—Ç —Å–≤—è–∑–∏ ‚Üí –∫–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è"
- `friends` - –¥—Ä—É–∑—å—è ‚Üí –∫–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π"
- `outgoing` - –∏—Å—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å ‚Üí –∫–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å"
- `incoming` - –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å ‚Üí –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–Ω—è—Ç—å" / "–û—Ç–∫–ª–æ–Ω–∏—Ç—å"

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. **Backend:**
   ```bash
   # –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
   supabase migration new friends_system
   
   # –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å SQL –∏–∑ 1-database.sql
   # –ü—Ä–∏–º–µ–Ω–∏—Ç—å
   supabase db push
   ```

2. **Frontend:**
   ```bash
   # –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
   mkdir -p entities/friend/{api,model,ui}
   
   # –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ö—É–∫–∏ –∏–∑ 2-api-hooks.md
   # –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ 3-ui-flows.md
   ```

3. **–ü—Ä–æ–≥—Ä–µ—Å—Å:**
   - –û—Ç–º–µ—á–∞–π –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –≤ `4-checklist.md`

---

## üìä Rate Limiting

| –£—Ä–æ–≤–µ–Ω—å | –õ–∏–º–∏—Ç | –û–∫–Ω–æ | –î–µ–π—Å—Ç–≤–∏—è |
|---------|-------|------|----------|
| **–î–Ω–µ–≤–Ω–æ–π** | 3 –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–¥–Ω–æ–º—É | 1 –¥–µ–Ω—å | –¢–æ–ª—å–∫–æ `send` |
| **Rate limit** | 5 –æ–ø–µ—Ä–∞—Ü–∏–π —Å –æ–¥–Ω–∏–º | 1 —á–∞—Å | `send`, `cancel`, `delete` |
| **–ì–ª–æ–±–∞–ª—å–Ω—ã–π** | 20 –æ–ø–µ—Ä–∞—Ü–∏–π –≤—Å–µ–≥–æ | 1 —á–∞—Å | –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è |

**–ù–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è:** `accept`, `reject` (—ç—Ç–æ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —á—É–∂–∏–µ –∑–∞–ø—Ä–æ—Å—ã)

---

## üéØ –ß—Ç–æ –¥–∞–ª—å—à–µ?

1. –ù–∞—á–Ω–∏ —Å **Backend** ‚Üí `1-database.sql`
2. –ò–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä—É–π **API —Ö—É–∫–∏** ‚Üí `2-api-hooks.md`
3. –°–æ–∑–¥–∞–π **UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã** ‚Üí `3-ui-flows.md`
4. –û—Ç–º–µ—á–∞–π –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Üí `4-checklist.md`
